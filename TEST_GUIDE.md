# テスト工程 - ドキュメント

## テスト用データセット

複数店舗のテスト用CSVファイルを用意しました。

### テスト用CSVファイル一覧

| ファイル名 | 店舗コード | 店舗名 | 売上件数 | 説明 |
|-----------|-----------|--------|--------|------|
| test_data_store_S002001.csv | S002001 | テスト店舗1 | 4件 | 基本的な販売データ |
| test_data_store_S002078.csv | S002078 | テスト店舗2 | 5件 | 複数カテゴリの販売データ |
| test_data_store_S003050.csv | S003050 | テスト店舗3 | 5件 | 異なる商品カテゴリのデータ |

## テスト手順

### 1. データベースクリア機能テスト
1. ブラウザでシステムにアクセス: http://localhost:10168
2. 管理者として ログイン (username: admin, password: admin123)
3. 管理者タブ → 「データをクリア」ボタンをクリック
4. ✅ データが削除されること確認
5. ✅ データ削除が監査ログに記録されて いることを確認（セキュリティタブ）

### 2. CSV アップロード - 複数店舗テスト
#### テスト① - 店舗S002001のアップロード
1. ダッシュボードに戻る
2. 「CSVをアップロード」でtest_data_store_S002001.csvを選択・アップロード
3. ✅ 「ファイルをアップロードしました」メッセージ確認
4. ✅ ダッシュボードに店舗データが表示される
5. ✅ au+1Collection売上が計算されている

#### テスト② - 店舗S002078のアップロード
1. 「CSVをアップロード」でtest_data_store_S002078.csvを選択・アップロード
2. ✅ 前のデータと統合される（追加される）
3. ✅ 売上合計が増加している

#### テスト③ - 店舗S003050のアップロード
1. 「CSVをアップロード」でtest_data_store_S003050.csvを選択・アップロード
2. ✅ 3つの店舗データすべてが統合表示される

### 3. データ表示確認テスト
1. 「店舗選択」ドロップダウンで各店舗を切り替え
2. ✅ 選択した店舗のデータのみ表示される
   - S002001: 4件
   - S002078: 5件
   - S003050: 5件
3. ✅ 店舗を変更したときにグラフが更新される

### 4. 権限別表示テスト

#### 管理者 (admin)
- ✅ すべての店舗データが表示される
- ✅ データクリア機能が利用可能
- ✅ セキュリティタブが表示される

#### マネージャー (店舗管理者)
1. 新規ユーザー作成で role=manager のユーザーを作成
2. ✅ 担当店舗のみデータ表示
3. ✅ データクリア機能は非表示

#### 一般ユーザー (staff)
1. 新規ユーザー作成で role=user のユーザーを作成
2. ✅ 担当店舗のみデータ表示
3. ✅ 管理者タブが非表示
4. ✅ セキュリティタブが非表示

### 5. セキュリティ機能テスト

#### ブルートフォース保護テスト
1. 間違ったパスワードで5回ログイン試行
2. ✅ 5回目の後、「ブルートフォース攻撃が検出されました」メッセージ表示
3. ✅ その後のログイン試行もブロック
4. セキュリティタブでログ確認

#### 監査ログテスト
1. セキュリティタブ → 「ログを読み込む」をクリック
2. ✅ 以下のイベントがログされている：
   - login_success (成功ログイン)
   - login_failure (失敗ログイン)
   - login_rate_limit_exceeded (ブルートフォース)
   - csv_uploaded (CSV アップロード)
   - security_logs_accessed (ログアクセス)

#### ログ削除機能テスト
1. セキュリティタブ → 「ログを読み込む」
2. 特定のログ行の「削除」ボタンをクリック
3. ✅ 確認ダイアログが表示
4. ✅ ログが削除される
5. 「ログ一括クリア」ボタンで全ログ削除確認
6. ✅ すべてのログが削除される

### 6. ユーザー管理テスト

#### 新規ユーザー作成
1. 管理者タブ → 「ユーザー作成」
2. 以下を入力:
   - ユーザー名: testuser01
   - パスワード: TestPass123
   - 店舗コード: S002001
   - 権限: manager
3. ✅ ユーザーが作成される
4. ✅ ユーザー一覧に表示される

#### パスワードリセット
1. ユーザー一覧で作成したユーザーを選択
2. 「パスワードをリセット」クリック
3. 新パスワード入力
4. ✅ パスワード変更完了メッセージ
5. ✅ 新パスワードでログイン可能

#### ユーザー削除
1. ユーザー一覧で testuser01 を選択
2. 「削除」クリック
3. ✅ 確認ダイアログ表示
4. ✅ ユーザーが削除される
5. ✅ 削除がセキュリティログに記録

## 期待される結果

### CSV アップロード後のデータ
- **総売上件数**: 14件 (4 + 5 + 5)
- **au+1Collection売上数**: 4件
- **平均商品単価**: 約105,000円

### パフォーマンス
- CSV アップロード処理: < 2秒
- ダッシュボード表示: < 1秒
- グラフ描画: < 3秒

## トラブルシューティング

### CSVアップロードエラー
- ファイルエンコーディングは UTF-8 BOM 付き推奨
- カラムヘッダーが正確か確認
- Excelで保存時は「CSV (コンマ区切り)」形式で保存

### ログイン失敗
- ユーザー名、パスワードの大文字/小文字を確認
- ブルートフォース保護で制限されていないか確認
- ブラウザキャッシュをクリア

### データが表示されない
- CSVアップロード後、ページをリロード
- トランザクション日付が正しいか確認（2026/02/15）
- ブラウザコンソールでエラーを確認

