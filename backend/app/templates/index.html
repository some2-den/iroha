<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iroha | å®Ÿç¸¾ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        header p {
            opacity: 0.9;
            font-size: 14px;
        }

        nav {
            background-color: #34495e;
            padding: 0;
            display: flex;
            gap: 0;
        }

        nav button {
            padding: 12px 20px;
            background-color: #34495e;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        nav button:hover {
            background-color: #455a64;
        }

        nav button.active {
            background-color: #3498db;
        }

        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        h3 {
            margin-top: 20px;
            margin-bottom: 15px;
            color: #34495e;
            font-size: 18px;
        }

        .upload-section {
            border: 2px dashed #bbb;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
        }

        .upload-section.hover {
            border-color: #3498db;
            background-color: #ecf0f1;
        }

        .upload-section input[type="file"] {
            display: none;
        }

        .upload-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }

        .upload-button:hover {
            background-color: #2980b9;
        }

        .upload-button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        .message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 4px;
            font-weight: 500;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            display: inline-block;
            margin-left: 8px;
            color: #7f8c8d;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: #f0f0f0;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #3498db;
        }

        .stat-card h3 {
            margin-top: 0;
            color: #555;
            font-size: 14px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
            margin-top: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        thead {
            background-color: #f0f0f0;
        }

        th {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
            font-weight: 600;
            color: #2c3e50;
        }

        td {
            padding: 12px;
            border: 1px solid #ddd;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .text-right {
            text-align: right;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chart-container {
            margin-top: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        canvas {
            max-width: 100%;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .error {
            color: #e74c3c;
            background-color: #fadbd8;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .summary-table thead {
            background-color: #ecf0f1;
        }

        .summary-table th {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
            font-weight: 600;
            color: #2c3e50;
        }

        .summary-table td {
            padding: 12px;
            border: 1px solid #ddd;
            color: #333;
        }

        .summary-table tbody tr:hover {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <header>
        <h1>ğŸ¦Š Iroha</h1>
        <p>S002078</p>
        <div style="margin-top: 15px; display: flex; align-items: center; gap: 15px;">
            <div id="storeSelectSection" style="display: none; align-items: center; gap: 15px;">
                <label for="storeSelect" style="font-weight: bold; color: white;">åº—èˆ—ï¼š</label>
                <select id="storeSelect" style="padding: 8px 12px; font-size: 16px; border-radius: 4px; border: none; background-color: #ecf0f1; min-width: 200px;">
                    <option value="">-- å…¨åº—èˆ— --</option>
                </select>
                <button onclick="saveStoreSelectionAndRefresh()" style="padding: 8px 12px; background-color: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">æ›´æ–°</button>
            </div>
            
            <!-- ãƒ­ã‚°ã‚¤ãƒ³UI -->
            <div id="authControls" style="margin-left: 20px; display: flex; gap: 8px; align-items: center;">
                <input id="loginUsername" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" style="padding: 6px; border-radius: 4px; border: none; min-width: 120px;" />
                <input id="loginPassword" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="padding: 6px; border-radius: 4px; border: none; min-width: 120px;" />
                <button id="loginBtn" class="upload-button" style="padding: 6px 10px;">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button id="logoutBtn" class="upload-button" style="padding: 6px 10px; display: none; background-color: #e67e22;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                <span id="loggedInUser" style="color: #ecf0f1; margin-left: 6px;"></span>
            </div>
        </div>
    </header>

    <nav style="display: none;">
        <button class="nav-btn active" data-tab="dashboard">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
        <button class="nav-btn" data-tab="staff">å€‹äººåˆ¥æˆç¸¾</button>
        <button class="nav-btn" data-tab="analysis">åˆ†æãƒ»ã‚°ãƒ©ãƒ•</button>
        <button class="nav-btn" data-tab="userSettings" id="userSettingsNavBtn" style="display: none;">è¨­å®š</button>
        <button class="nav-btn" data-tab="admin" id="adminNavBtn">ç®¡ç†è€…</button>
        <button class="nav-btn" data-tab="security" id="securityNavBtn" style="display: none;">ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</button>
    </nav>

    <main style="display: none;">
        <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
        <div id="dashboard" class="tab-content active">
            <div class="container">
                <h2>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
                
                <!-- au+1Collectionå…¨ä½“çµ±è¨ˆ -->
                <h3>au+1Collectionå…¨ä½“å®Ÿç¸¾</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>åˆè¨ˆå£²ä¸Š</h3>
                        <div class="stat-value">Â¥<span id="au1TotalSales">0</span></div>
                    </div>
                    <div class="stat-card">
                        <h3>åˆè¨ˆç²—åˆ©</h3>
                        <div class="stat-value">Â¥<span id="au1TotalGrossProfit">0</span></div>
                    </div>
                    <div class="stat-card">
                        <h3>å–ä»¶æ•°</h3>
                        <div class="stat-value"><span id="au1TransactionCount">0</span>ä»¶</div>
                    </div>
                    <div class="stat-card">
                        <h3>ç²—åˆ©ç‡</h3>
                        <div class="stat-value"><span id="au1GrossProfitRate">0</span>%</div>
                    </div>
                </div>

                <h3>ã‚¹ã‚¿ãƒƒãƒ•åˆ¥å®Ÿç¸¾</h3>
                <div id="staffPerformanceTable"></div>

                <h3 style="margin-top: 40px;">å°å½“ãŸã‚Šå˜ä¾¡ ã‚¹ã‚¿ãƒƒãƒ•ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                <div id="unitPriceRankingTable"></div>
            </div>
        </div>

        <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
        <!-- å€‹äººåˆ¥æˆç¸¾ -->
        <div id="staff" class="tab-content">
            <div class="container">
                <h2>au+1Collectionå®Ÿç¸¾</h2>
                
                <div style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                    <div>
                        <label for="staffSelect">ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ:</label>
                        <select id="staffSelect" style="padding: 8px; font-size: 14px;">
                            <option value="">-- å…¨å“¡ --</option>
                        </select>
                    </div>
                    <div>
                        <label for="startDateFilter">é–‹å§‹æ—¥:</label>
                        <input type="date" id="startDateFilter" style="padding: 8px; font-size: 14px;">
                    </div>
                    <div>
                        <label for="endDateFilter">çµ‚äº†æ—¥:</label>
                        <input type="date" id="endDateFilter" style="padding: 8px; font-size: 14px;">
                    </div>
                    <button class="upload-button" onclick="setCurrentMonth()" style="padding: 8px 12px; font-size: 14px;">å½“æœˆ</button>
                    <button class="upload-button" onclick="loadAu1CollectionData()" style="padding: 8px 12px; font-size: 14px;">æ¤œç´¢</button>
                </div>

                <!-- ã‚µãƒãƒªãƒ¼çµ±è¨ˆ -->
                <div style="margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
                    <h3 style="margin-top: 0;">au+1Collectionçµ±è¨ˆ</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div style="padding: 10px; background-color: white; border-radius: 4px; border-left: 4px solid #3498db;">
                            <div style="font-size: 12px; color: #666;">åˆè¨ˆå£²ä¸Š</div>
                            <div style="font-size: 24px; font-weight: bold; color: #3498db;">Â¥<span id="au1StaffTotalSales" style="white-space: nowrap;">0</span></div>
                        </div>
                        <div style="padding: 10px; background-color: white; border-radius: 4px; border-left: 4px solid #2ecc71;">
                            <div style="font-size: 12px; color: #666;">åˆè¨ˆç²—åˆ©</div>
                            <div style="font-size: 24px; font-weight: bold; color: #2ecc71;">Â¥<span id="au1StaffTotalProfit" style="white-space: nowrap;">0</span></div>
                        </div>
                        <div style="padding: 10px; background-color: white; border-radius: 4px; border-left: 4px solid #e74c3c;">
                            <div style="font-size: 12px; color: #666;">å–ä»¶æ•°</div>
                            <div style="font-size: 24px; font-weight: bold; color: #e74c3c;"><span id="au1StaffTotalCount" style="white-space: nowrap;">0</span>ä»¶</div>
                        </div>
                    </div>
                </div>

                <!-- ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å°å½“ãŸã‚Šå˜ä¾¡ -->
                <div style="margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
                    <h3 style="margin-top: 0;">ğŸ“± ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å°å½“ãŸã‚Šå˜ä¾¡</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background-color: white;">
                            <thead>
                                <tr style="background-color: #ecf0f1; color: #2c3e50;">
                                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">ã‚¹ã‚¿ãƒƒãƒ•</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">au+1ç²—åˆ©</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">iPhone</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">å°å½“ãŸã‚Šå˜ä¾¡</th>
                                </tr>
                            </thead>
                            <tbody id="unitPriceTableBody">
                                <tr>
                                    <td colspan="5" style="padding: 20px; text-align: center; color: #999;">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ã‚¹ã‚¿ãƒƒãƒ•åˆ¥å®Ÿç¸¾ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <h3>ã‚¹ã‚¿ãƒƒãƒ•åˆ¥å®Ÿç¸¾</h3>
                <div id="au1StaffTable"></div>

                <!-- ä¸­åˆ†é¡åˆ¥å®Ÿç¸¾ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <h3 style="margin-top: 30px;">ä¸­åˆ†é¡åˆ¥é›†è¨ˆ</h3>
                <div id="au1CategoryTable"></div>

                <!-- ä¸­åˆ†é¡åˆ¥ç²—åˆ©å††ã‚°ãƒ©ãƒ• -->
                <div style="margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div style="padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
                        <h3 style="margin-top: 0;">ä¸­åˆ†é¡åˆ¥ç²—åˆ©ï¼ˆå††ã‚°ãƒ©ãƒ•ï¼‰</h3>
                        <canvas id="categoryProfitChart" height="80"></canvas>
                    </div>
                    <div style="padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
                        <h3 style="margin-top: 0;">ä¸­åˆ†é¡åˆ¥å£²ä¸Šï¼ˆå††ã‚°ãƒ©ãƒ•ï¼‰</h3>
                        <canvas id="categorySalesChart" height="80"></canvas>
                    </div>
                </div>

                <!-- å•†å“åˆ¥å®Ÿç¸¾ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <h3 style="margin-top: 30px;">å•†å“åˆ¥å®Ÿç¸¾</h3>
                <div id="au1ProductTable"></div>
            </div>
        </div>

        <!-- åˆ†æã‚°ãƒ©ãƒ• -->
        <div id="analysis" class="tab-content">
            <div class="container">
                <h2>åˆ†æãƒ»ã‚°ãƒ©ãƒ•</h2>
                <div class="chart-container">
                    <h3>æ—¥åˆ¥å£²ä¸Šæ¨ç§»ï¼ˆå…¨ä½“ï¼‰</h3>
                    <canvas id="dailyChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>æ—¥åˆ¥å£²ä¸Šæ¨ç§»ï¼ˆau+1Collectionï¼‰</h3>
                    <canvas id="au1DailyChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>å•†å“åˆ¥å£²ä¸Šï¼ˆTOP25ï¼‰</h3>
                    <canvas id="productChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘è¨­å®šãƒšãƒ¼ã‚¸ -->
        <div id="userSettings" class="tab-content">
            <div class="container">
                <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š</h2>

                <div style="margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
                    <h3>CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæ‰€å±åº—èˆ—ã®ã¿ï¼‰</h3>
                    <div class="upload-section" id="userUploadSection">
                        <p style="font-size: 16px; margin-bottom: 15px;">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
                        <input type="file" id="userCsvFile" accept=".csv" />
                        <button class="upload-button" onclick="document.getElementById('userCsvFile').click()">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
                        <button class="upload-button" id="userUploadBtn" disabled>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                        <div id="userUploadMessage"></div>
                    </div>
                </div>

                <div style="margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
                    <h3>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h3>
                    <div style="margin-bottom: 10px;">
                        <label for="userOldPassword">ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                        <input type="password" id="userOldPassword" style="padding: 8px; font-size: 14px; width: 100%; box-sizing: border-box;" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label for="userNewPassword">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                        <input type="password" id="userNewPassword" style="padding: 8px; font-size: 14px; width: 100%; box-sizing: border-box;" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label for="userConfirmPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª:</label>
                        <input type="password" id="userConfirmPassword" style="padding: 8px; font-size: 14px; width: 100%; box-sizing: border-box;" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªç”¨ï¼‰">
                    </div>
                    <button class="upload-button" id="userChangePasswordBtn" style="padding: 8px 12px; font-size: 14px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
                    <div id="userChangePasswordMessage" style="margin-top: 10px;"></div>
                </div>
            </div>
        </div>

        <!-- ç®¡ç†è€…ãƒšãƒ¼ã‚¸ -->
        <div id="admin" class="tab-content">
            <div class="container">
                <h2>ç®¡ç†è€…</h2>
                
                <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div id="adminLoginForm" style="margin-bottom: 30px; padding: 20px; background-color: #f9f9f9; border-radius: 8px;">
                    <h3>ç®¡ç†è€…èªè¨¼</h3>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <div>
                            <label for="adminPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                            <input type="password" id="adminPassword" style="padding: 8px; font-size: 14px;" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                        </div>
                        <button class="upload-button" onclick="verifyAdminPassword()" style="padding: 8px 12px; font-size: 14px;">ãƒ­ã‚°ã‚¤ãƒ³</button>
                    </div>
                    <div id="adminLoginMessage" style="margin-top: 10px;"></div>
                </div>
                
                <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆéè¡¨ç¤ºï¼‰ -->
                <div id="adminContent" style="display: none;">
                    <h3>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                    <div class="upload-section" id="uploadSection">
                        <p style="font-size: 16px; margin-bottom: 15px;">
                            CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
                        </p>
                        <input type="file" id="csvFile" accept=".csv" />
                        <button class="upload-button" onclick="document.getElementById('csvFile').click()">
                            ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                        </button>
                        <button class="upload-button" id="uploadBtn" disabled>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                        <div id="uploadMessage"></div>
                    </div>

                    <h3 style="margin-top: 30px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h3>
                    <div style="margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
                        <div style="margin-bottom: 10px;">
                            <label for="oldPassword">ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                            <input type="password" id="oldPassword" style="padding: 8px; font-size: 14px;" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label for="newPassword">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                            <input type="password" id="newPassword" style="padding: 8px; font-size: 14px;" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label for="confirmPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª:</label>
                            <input type="password" id="confirmPassword" style="padding: 8px; font-size: 14px;" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªç”¨ï¼‰">
                        </div>
                        <button class="upload-button" onclick="changeAdminPassword()" style="padding: 8px 12px; font-size: 14px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
                        <div id="changePasswordMessage" style="margin-top: 10px;"></div>
                    </div>

                    <h3 style="margin-top: 30px;">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
                    <div style="margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
                        <p style="margin-bottom: 15px; color: #666;">ã™ã¹ã¦ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
                        <button class="upload-button" onclick="clearAllData()" style="padding: 8px 12px; font-size: 14px; background-color: #e74c3c;">ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
                        <div id="clearDataMessage" style="margin-top: 10px;"></div>
                    </div>

                    <h3 style="margin-top: 30px;">ğŸ¢ åº—èˆ—ç®¡ç†</h3>
                    <div style="margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
                        <h4 style="font-size: 16px; color: #34495e; margin-bottom: 15px;">ç™»éŒ²æ¸ˆã¿åº—èˆ—ä¸€è¦§</h4>
                        <div style="overflow-x: auto;">
                            <table id="storeListTable" style="width: 100%; border-collapse: collapse; background-color: white; border-radius: 8px; overflow: hidden;">
                                <thead>
                                    <tr style="background-color: #ecf0f1; color: #2c3e50;">
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">åº—èˆ—ã‚³ãƒ¼ãƒ‰</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">åº—èˆ—å</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">æ‰€åœ¨åœ°</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="storeListTableBody">
                                    <tr>
                                        <td colspan="4" style="padding: 20px; text-align: center; color: #999;">åº—èˆ—ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <button class="upload-button" onclick="loadAdminStoreList()" style="padding: 8px 12px; margin-top: 10px; background-color: #27ae60;">åº—èˆ—ä¸€è¦§ã‚’æ›´æ–°</button>
                        <div id="storeListMessage" style="margin-top: 10px;"></div>
                    </div>

                    <h3 style="margin-top: 30px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h3>ï¿½ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h3>
                    
                    <h4 style="margin-top: 25px; font-size: 16px; color: #34495e;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ</h4>
                    <div style="margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div>
                                <label for="newUsername">ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</label>
                                <input type="text" id="newUsername" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label for="newUserPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                                <input type="password" id="newUserPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label for="newStoreCode">åº—èˆ—ã‚³ãƒ¼ãƒ‰:</label>
                                <input type="text" id="newStoreCode" placeholder="S002078" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label for="newRole">æ¨©é™:</label>
                                <select id="newRole" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="user">ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
                                    <option value="manager">ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</option>
                                    <option value="admin">ç®¡ç†è€…</option>
                                </select>
                            </div>
                        </div>
                        <button class="upload-button" onclick="createNewUser()" style="padding: 8px 12px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ</button>
                        <div id="createUserMessage" style="margin-top: 10px;"></div>
                    </div>

                    <h4 style="margin-top: 25px; font-size: 16px; color: #34495e;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h4>
                    <div style="overflow-x: auto; margin-top: 10px;">
                        <table id="userListTable" style="width: 100%; border-collapse: collapse; background-color: white; border-radius: 8px; overflow: hidden;">
                            <thead>
                                <tr style="background-color: #ecf0f1; color: #2c3e50;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">ID</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">ã‚¹ã‚¿ãƒƒãƒ•å</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">åº—èˆ—ã‚³ãƒ¼ãƒ‰</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">æ¨©é™</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">çŠ¶æ…‹</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="userListTableBody">
                                <tr>
                                    <td colspan="7" style="padding: 20px; text-align: center; color: #999;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button class="upload-button" onclick="loadUserList()" style="padding: 8px 12px; margin-top: 10px; background-color: #27ae60;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’æ›´æ–°</button>
                    <div id="userListMessage" style="margin-top: 10px;"></div>

                    <h3 style="margin-top: 30px;">ï¿½ğŸ“‹ SQLãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</h3>
                    <div style="margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
                        <p style="margin-bottom: 15px;">ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: <strong id="totalRecordCount">0</strong></p>
                        <button class="upload-button" onclick="loadSalesData()" style="padding: 8px 12px; font-size: 14px; background-color: #27ae60;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿</button>
                        <div id="salesDataMessage" style="margin-top: 10px;"></div>
                    </div>

                    <div style="margin-top: 20px;">
                        <h3>ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
                            <div>
                                <label for="filterField">æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:</label>
                                <select id="filterField" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    <option value="staff_name">ã‚¹ã‚¿ãƒƒãƒ•å</option>
                                    <option value="product_name">å•†å“å</option>
                                    <option value="store_code">åº—èˆ—ã‚³ãƒ¼ãƒ‰</option>
                                    <option value="store_name">åº—èˆ—å</option>
                                    <option value="large_category">å¤§åˆ†é¡</option>
                                    <option value="small_category">ä¸­åˆ†é¡</option>
                                    <option value="service_category">ã‚µãƒ¼ãƒ“ã‚¹ã‚«ãƒ†ã‚´ãƒª</option>
                                </select>
                            </div>
                            <div>
                                <label for="filterValue">æ¤œç´¢å€¤:</label>
                                <input type="text" id="filterValue" placeholder="æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                        <p id="filterMatchCount" style="font-size: 14px; color: #666; margin-bottom: 10px;"></p>
                    </div>

                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table id="salesDataTable" style="width: 100%; border-collapse: collapse; background-color: white; border-radius: 8px; overflow: hidden;">
                            <thead>
                                <tr style="background-color: #ecf0f1; color: #2c3e50;">                                    <th style="padding: 12px; text-align: left; cursor: pointer; border-bottom: 1px solid #ddd;" onclick="sortTable('id')">ID â†•</th>
                                    <th style="padding: 12px; text-align: left; cursor: pointer; border-bottom: 1px solid #ddd;" onclick="sortTable('transaction_date')">å–å¼•æ—¥æ™‚ â†•</th>
                                    <th style="padding: 12px; text-align: left; cursor: pointer; border-bottom: 1px solid #ddd;" onclick="sortTable('store_code')">åº—èˆ—ã‚³ãƒ¼ãƒ‰ â†•</th>
                                    <th style="padding: 12px; text-align: left; cursor: pointer; border-bottom: 1px solid #ddd;" onclick="sortTable('store_name')">åº—èˆ—å â†•</th>
                                    <th style="padding: 12px; text-align: left; cursor: pointer; border-bottom: 1px solid #ddd;" onclick="sortTable('product_name')">å•†å“å â†•</th>
                                    <th style="padding: 12px; text-align: left; cursor: pointer; border-bottom: 1px solid #ddd;" onclick="sortTable('quantity')">æ•°é‡ â†•</th>
                                    <th style="padding: 12px; text-align: left; cursor: pointer; border-bottom: 1px solid #ddd;" onclick="sortTable('total_price')">åˆè¨ˆé‡‘é¡ â†•</th>
                                    <th style="padding: 12px; text-align: left; cursor: pointer; border-bottom: 1px solid #ddd;" onclick="sortTable('gross_profit')">ç²—åˆ© â†•</th>
                                    <th style="padding: 12px; text-align: left; cursor: pointer; border-bottom: 1px solid #ddd;" onclick="sortTable('staff_name')">ã‚¹ã‚¿ãƒƒãƒ•å â†•</th>
                                    <th style="padding: 12px; text-align: left; cursor: pointer; border-bottom: 1px solid #ddd;" onclick="sortTable('large_category')">å¤§åˆ†é¡ â†•</th>
                                    <th style="padding: 12px; text-align: left; cursor: pointer; border-bottom: 1px solid #ddd;" onclick="sortTable('small_category')">ä¸­åˆ†é¡ â†•</th>
                                </tr>
                            </thead>
                            <tbody id="salesDataTableBody">
                                <tr>
                                    <td colspan="11" style="padding: 20px; text-align: center; color: #999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    </div>
            </div>
        </div>
        
        <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç®¡ç†ã‚¿ãƒ– -->
        <div id="security" class="tab-content">
            <div class="container">
                <h2>ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç®¡ç†</h2>
                
                <h3 style="margin-top: 25px;">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°çµ±è¨ˆ</h3>
                <div style="margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
                    <button class="upload-button" onclick="loadSecurityStats()" style="padding: 8px 12px; background-color: #27ae60; margin-bottom: 15px;">çµ±è¨ˆã‚’æ›´æ–°</button>
                    <div id="securityStatsMessage"></div>
                </div>
                
                <h3 style="margin-top: 25px;">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°</h3>
                <div style="margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
                    <div style="margin-bottom: 15px;">
                        <button class="upload-button" onclick="loadSecurityLogs()" style="padding: 8px 12px; background-color: #2980b9; margin-right: 5px;">ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã‚€</button>
                        <button class="upload-button" onclick="clearAllSecurityLogs()" style="padding: 8px 12px; background-color: #c0392b;">ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
                    </div>
                    <div style="max-height: 600px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background-color: #ecf0f1; position: sticky; top: 0;">
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">ã‚¤ãƒ™ãƒ³ãƒˆ</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">IPã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #ddd;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="securityLogsTableBody">
                                <tr>
                                    <td colspan="6" style="padding: 10px; text-align: center; color: #999;">ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        const API_BASE = '/api';

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                switchTab(tabName);
                if (tabName === 'dashboard') loadDashboard();
                if (tabName === 'analysis') loadAnalysis();
                if (tabName === 'staff') {
                    loadStaffList();
                    // å½“æœˆã‚’åˆæœŸåŒ–ã—ã¦ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                    document.getElementById('startDateFilter').value = '';
                    document.getElementById('endDateFilter').value = '';
                    setCurrentMonth();
                    setTimeout(() => loadAu1CollectionData(), 500);
                }
            });
        });

        function switchTab(tabName) {
            // ç®¡ç†è€…ã‚¿ãƒ–ã¸ç„¡æ¨©é™ã§é·ç§»ã—ãªã„ã‚ˆã†ã«ã‚¬ãƒ¼ãƒ‰
            if (tabName === 'admin') {
                const role = localStorage.getItem('userRole');
                const userId = localStorage.getItem('userId');
                // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„ï¼ˆç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ï¼‰ã‹ role === 'admin' ã®å ´åˆã®ã¿è¨±å¯
                if (userId && role !== 'admin') {
                    alert('ç®¡ç†è€…ç”»é¢ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
            }

            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if (event && event.target) event.target.classList.add('active');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        const uploadSection = document.getElementById('uploadSection');
        const csvFile = document.getElementById('csvFile');
        const uploadBtn = document.getElementById('uploadBtn');

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('hover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('hover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('hover');
            if (e.dataTransfer.files.length > 0) {
                csvFile.files = e.dataTransfer.files;
                handleFileSelected();
            }
        });

        csvFile.addEventListener('change', handleFileSelected);

        function handleFileSelected() {
            uploadBtn.disabled = !csvFile.files.length;
        }

        uploadBtn.addEventListener('click', async () => {
            if (!csvFile.files.length) return;

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
            const messageDiv = document.getElementById('uploadMessage');
            messageDiv.innerHTML = '';

            try {
                const formData = new FormData();
                formData.append('file', csvFile.files[0]);
                
                const response = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    let successMsg = `<div class="message success">âœ“ ${data.count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`;
                    
                    // åº—èˆ—æƒ…å ±ã‚’è¿½åŠ 
                    if (data.stores && data.stores.length > 0) {
                        successMsg += `<br/>åº—èˆ—: ${data.stores.join(', ')}`;
                    }
                    
                    successMsg += `</div>`;
                    messageDiv.innerHTML = successMsg;
                    csvFile.value = '';
                    
                    // åº—èˆ—ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                    setTimeout(() => {
                        loadStoreList();
                        switchTab('dashboard');
                    }, 1500);
                } else {
                    messageDiv.innerHTML = `<div class="message error">âœ— ã‚¨ãƒ©ãƒ¼: ${data.detail}</div>`;
                }
            } catch (error) {
                messageDiv.innerHTML = `<div class="message error">âœ— ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰';
            }
        });

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
        async function loadDashboard() {
            try {
                // au+1Collectionçµ±è¨ˆã‚‚èª­ã¿è¾¼ã¿
                loadDashboardStats();
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function setDashboardCurrentMonth() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            
            // å½“æœˆã®1æ—¥
            const firstDay = `${year}-${month}-01`;
            
            // å½“æœˆã®æœ€çµ‚æ—¥
            const lastDay = new Date(year, today.getMonth() + 1, 0);
            const lastDayStr = `${year}-${month}-${String(lastDay.getDate()).padStart(2, '0')}`;
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            localStorage.setItem('dashboardStartDate', firstDay);
            localStorage.setItem('dashboardEndDate', lastDayStr);
            
            loadDashboardStats();
        }

        async function loadDashboardStats() {
            try {
                const startDate = localStorage.getItem('dashboardStartDate') || '';
                const endDate = localStorage.getItem('dashboardEndDate') || '';
                const storeCode = document.getElementById('storeSelect').value;
                
                let url = `${API_BASE}/au1-collection/total`;
                let staffUrl = `${API_BASE}/au1-collection/summary`;
                let unitPriceUrl = `${API_BASE}/smartphone/unit-price`;
                
                const params = new URLSearchParams();
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);
                if (storeCode) params.append('store_code', storeCode);
                const queryString = params.toString() ? '?' + params.toString() : '';
                
                url += queryString;
                staffUrl += queryString;
                unitPriceUrl += queryString;
                
                // å…¨ä½“çµ±è¨ˆã‚’èª­ã¿è¾¼ã¿
                const response = await fetch(url);
                const data = await response.json();
                
                const totalSales = data.total_sales || 0;
                const grossProfit = data.gross_profit || 0;
                const transactionCount = data.transaction_count || 0;
                const profitRate = totalSales > 0 ? ((grossProfit / totalSales) * 100).toFixed(2) : 0;
                
                document.getElementById('au1TotalSales').textContent = Math.round(totalSales).toLocaleString('ja-JP');
                document.getElementById('au1TotalGrossProfit').textContent = Math.round(grossProfit).toLocaleString('ja-JP');
                document.getElementById('au1TransactionCount').textContent = transactionCount;
                document.getElementById('au1GrossProfitRate').textContent = profitRate;
                
                // ã‚¹ã‚¿ãƒƒãƒ•åˆ¥å®Ÿç¸¾ã¨å°å½“ãŸã‚Šå˜ä¾¡ã‚’èª­ã¿è¾¼ã¿
                const staffResponse = await fetch(staffUrl);
                const staffData = await staffResponse.json();
                
                const unitPriceResponse = await fetch(unitPriceUrl);
                const unitPriceData = await unitPriceResponse.json();
                
                renderDashboardStaffTable(staffData);
                renderUnitPriceRanking(unitPriceData);  // æ­£ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™
            } catch (error) {
                console.error('au+1Collectionçµ±è¨ˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function renderDashboardStaffTable(data) {
            const tableDiv = document.getElementById('staffPerformanceTable');
            
            if (!data || data.length === 0) {
                tableDiv.innerHTML = '<p style="color: #666;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            let html = '<table class="summary-table"><thead><tr>';
            html += '<th>ã‚¹ã‚¿ãƒƒãƒ•</th>';
            html += '<th style="text-align: center;">å–ä»¶æ•°</th>';
            html += '<th style="text-align: right;">å£²ä¸Š</th>';
            html += '<th style="text-align: right;">ç²—åˆ©</th>';
            html += '<th style="text-align: right;">ç²—åˆ©ç‡</th>';
            html += '</tr></thead><tbody>';
            
            data.forEach(staff => {
                const profitRate = staff.total_sales > 0 ? ((staff.gross_profit / staff.total_sales) * 100).toFixed(2) : 0;
                
                html += '<tr>';
                html += `<td><strong>${staff.staff_name}</strong><br/><small style="color: #999;">${staff.staff_id}</small></td>`;
                html += `<td style="text-align: center;">${staff.transaction_count}</td>`;
                html += `<td style="text-align: right;">Â¥${Math.round(staff.total_sales).toLocaleString('ja-JP')}</td>`;
                html += `<td style="text-align: right;">Â¥${Math.round(staff.gross_profit).toLocaleString('ja-JP')}</td>`;
                html += `<td style="text-align: right;">${profitRate}%</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            tableDiv.innerHTML = html;
        }

        function renderUnitPriceRanking(data) {
            const tableDiv = document.getElementById('unitPriceRankingTable');
            
            if (!data || data.length === 0) {
                tableDiv.innerHTML = '<p style="color: #666;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // unit_price ã®å€¤ã§ã‚½ãƒ¼ãƒˆï¼ˆé«˜ã„é †ï¼‰
            const staffWithRank = [...data].sort((a, b) => {
                const priceA = a.unit_price || 0;
                const priceB = b.unit_price || 0;
                return priceB - priceA;
            });
            
            let html = '<table class="summary-table"><thead><tr>';
            html += '<th style="text-align: center;">é †ä½</th>';
            html += '<th>ã‚¹ã‚¿ãƒƒãƒ•</th>';
            html += '<th style="text-align: right;">au+1ç²—åˆ©</th>';
            html += '<th style="text-align: center;">ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³</th>';
            html += '<th style="text-align: center;">iPhone</th>';
            html += '<th style="text-align: right;">å°å½“ãŸã‚Šå˜ä¾¡</th>';
            html += '</tr></thead><tbody>';
            
            staffWithRank.forEach((staff, index) => {
                html += '<tr>';
                html += `<td style="text-align: center;"><strong>${index + 1}</strong></td>`;
                html += `<td><strong>${staff.staff_name}</strong><br/><small style="color: #999;">${staff.staff_id}</small></td>`;
                html += `<td style="text-align: right;">Â¥${Math.round(staff.au1_gross_profit || 0).toLocaleString('ja-JP')}</td>`;
                html += `<td style="text-align: center;">${staff.smartphone_count || 0}</td>`;
                html += `<td style="text-align: center;">${staff.iphone_count || 0}</td>`;
                html += `<td style="text-align: right;">Â¥${Math.round(staff.unit_price || 0).toLocaleString('ja-JP')}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            tableDiv.innerHTML = html;
        }

        // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ï¼ˆUI/ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ ---
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½
        async function createNewUser() {
            try {
                // è¦ç´ ã‚’ç¢ºèª
                const usernameElem = document.getElementById('newUsername');
                const passwordElem = document.getElementById('newUserPassword');
                const storeCodeElem = document.getElementById('newStoreCode');
                const roleElem = document.getElementById('newRole');
                
                console.log('è¦ç´ ãƒã‚§ãƒƒã‚¯:', {
                    usernameElem: !!usernameElem,
                    passwordElem: !!passwordElem,
                    storeCodeElem: !!storeCodeElem,
                    roleElem: !!roleElem
                });

                const username = usernameElem.value.trim();
                const password = passwordElem.value.trim();
                const storeCode = storeCodeElem.value.trim();
                const role = roleElem.value;

                console.log('å…¥åŠ›å€¤:', { 
                    username: `"${username}"`, 
                    password: password ? 'â—â—â—' : 'ç©ºæ–‡å­—åˆ—',
                    storeCode: `"${storeCode}"`,
                    role: `"${role}"`
                });
                console.log('ãƒã‚§ãƒƒã‚¯çµæœ:', {
                    '!username': !username,
                    '!password': !password,
                    '!storeCode': !storeCode
                });

                if (!username || !password || !storeCode) {
                    alert('ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\n\n' +
                        'ãƒ¦ãƒ¼ã‚¶ãƒ¼å: "' + username + '"\n' +
                        'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ' + (password ? 'â—â—â—' : 'ã€æœªå…¥åŠ›ã€‘') + '\n' +
                        'åº—èˆ—ã‚³ãƒ¼ãƒ‰: "' + storeCode + '"\n' +
                        'æ¨©é™: "' + role + '"');
                    return;
                }

                const adminUserId = localStorage.getItem('userId');
                const res = await fetch(`${API_BASE}/auth/admin/create-user?admin_user_id=${adminUserId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username, password, staff_id: storeCode, staff_name: username, store_code: storeCode, role
                    })
                });

                const data = await res.json();
                const msgDiv = document.getElementById('createUserMessage');
                if (res.ok) {
                    msgDiv.innerHTML = `<div class="message success">âœ“ ${data.message}</div>`;
                    document.getElementById('newUsername').value = '';
                    document.getElementById('newUserPassword').value = '';
                    document.getElementById('newStoreCode').value = '';
                    setTimeout(() => loadUserList(), 800);
                } else {
                    msgDiv.innerHTML = `<div class="message error">âœ— ${data.detail}</div>`;
                }
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('createUserMessage').innerHTML = `<div class="message error">âœ— ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }

        async function loadUserList() {
            try {
                const adminUserId = localStorage.getItem('userId');
                const res = await fetch(`${API_BASE}/auth/admin/users?admin_user_id=${adminUserId}`);
                if (!res.ok) throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');

                const users = await res.json();
                const tableBody = document.getElementById('userListTableBody');
                
                if (users.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #999;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                    return;
                }

                let html = '';
                users.forEach((user, idx) => {
                    const bgColor = idx % 2 === 0 ? '#ffffff' : '#f9f9f9';
                    const statusText = user.is_active ? 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–';
                    let roleText = 'ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼';
                    if (user.role === 'admin') {
                        roleText = 'ç®¡ç†è€…';
                    } else if (user.role === 'manager') {
                        roleText = 'ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼';
                    }
                    
                    // staff_nameã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
                    const escapedStaffName = (user.staff_name || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    
                    html += `<tr style="background-color: ${bgColor}; border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;">${user.id}</td>
                        <td style="padding: 10px; font-weight: bold;">${user.username}</td>
                        <td style="padding: 10px;">${user.staff_name}</td>
                        <td style="padding: 10px;">${user.store_code}</td>
                        <td style="padding: 10px;">${roleText}</td>
                        <td style="padding: 10px;">${statusText}</td>
                        <td style="padding: 10px;">
                            <button class="upload-button" onclick="resetUserPassword('${user.username}')" style="padding: 4px 8px; font-size: 12px; background-color: #e67e22; margin-right: 4px;">ãƒªã‚»ãƒƒãƒˆ</button>
                            <button class="upload-button" onclick="editUserStaffName(this)" data-username="${user.username}" data-staff-name="${escapedStaffName}" style="padding: 4px 8px; font-size: 12px; background-color: #3498db; margin-right: 4px;">ç·¨é›†</button>
                            <button class="upload-button" onclick="deleteUser('${user.username}')" style="padding: 4px 8px; font-size: 12px; background-color: #e74c3c;">å‰Šé™¤</button>
                        </td>
                    </tr>`;
                });
                
                tableBody.innerHTML = html;
                document.getElementById('userListMessage').innerHTML = `<p style="color: #2ecc71;">âœ“ ${users.length} ä»¶ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ</p>`;
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('userListMessage').innerHTML = `<p style="color: #e74c3c;">âœ— ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        // Admin ãƒšãƒ¼ã‚¸ç”¨ã®åº—èˆ—ä¸€è¦§èª­ã¿è¾¼ã¿é–¢æ•°
        async function loadAdminStoreList() {
            try {
                console.log('ğŸ”„ Loading store list for admin panel...');
                const response = await fetch(`${API_BASE}/admin/stores`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                const stores = result.data || [];
                console.log('ğŸ“ Stores loaded:', stores);
                
                const tableBody = document.getElementById('storeListTableBody');
                if (!tableBody) {
                    console.error('âŒ storeListTableBody element not found');
                    return;
                }
                
                if (stores.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #999;">åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                    return;
                }
                
                let html = '';
                stores.forEach((store, idx) => {
                    const bgColor = idx % 2 === 0 ? '#ffffff' : '#f9f9f9';
                    html += `<tr style="background-color: ${bgColor}; border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px; font-weight: bold;">${store.store_code}</td>
                        <td style="padding: 10px;">${store.store_name}</td>
                        <td style="padding: 10px;">${store.location || 'æœªè¨­å®š'}</td>
                        <td style="padding: 10px; text-align: center;">
                            <button class="upload-button" onclick="deleteAdminStore(${store.id}, '${store.store_code}', '${store.store_name}')" style="padding: 4px 8px; font-size: 12px; background-color: #e74c3c;">å‰Šé™¤</button>
                        </td>
                    </tr>`;
                });
                
                tableBody.innerHTML = html;
                const msgElement = document.getElementById('storeListMessage');
                if (msgElement) {
                    msgElement.innerHTML = `<p style="color: #2ecc71;">âœ“ ${stores.length} ä»¶ã®åº—èˆ—ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ</p>`;
                }
                console.log('âœ… Store list loaded successfully');
            } catch (error) {
                console.error('âŒ Store list loading error:', error);
                const msgElement = document.getElementById('storeListMessage');
                if (msgElement) {
                    msgElement.innerHTML = `<p style="color: #e74c3c;">âœ— ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
                }
            }
        }

        // Admin ãƒšãƒ¼ã‚¸ç”¨ã®åº—èˆ—å‰Šé™¤é–¢æ•°
        async function deleteAdminStore(storeId, storeCode, storeName) {
            if (!confirm(`åº—èˆ—ã€Œ${storeName}ã€(${storeCode})ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“`)) return;

            try {
                const adminUserId = localStorage.getItem('userId');
                const response = await fetch(
                    `${API_BASE}/admin/delete-store?store_id=${storeId}&admin_user_id=${adminUserId}`,
                    { method: 'DELETE' }
                );

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const msgElement = document.getElementById('storeListMessage');
                if (msgElement) {
                    msgElement.innerHTML = `<p style="color: #2ecc71;">âœ“ åº—èˆ—ã€Œ${storeName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ</p>`;
                }
                
                // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                await loadAdminStoreList();
            } catch (error) {
                console.error('âŒ Store deletion error:', error);
                const msgElement = document.getElementById('storeListMessage');
                if (msgElement) {
                    msgElement.innerHTML = `<p style="color: #e74c3c;">âœ— ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
                }
            }
        }

        async function resetUserPassword(username) {
            if (!confirm(`${username} ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ`)) return;

            try {
                const adminUserId = localStorage.getItem('userId');
                const res = await fetch(`${API_BASE}/auth/admin/reset-password?admin_user_id=${adminUserId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                const data = await res.json();
                if (res.ok) {
                    alert(`ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ\næ–°ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ${data.default_password}`);
                    loadUserList();
                } else {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${data.detail}`);
                }
            } catch (error) {
                console.error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        async function deleteUser(username) {
            if (!confirm(`${username} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) return;

            try {
                const adminUserId = localStorage.getItem('userId');
                const res = await fetch(`${API_BASE}/auth/admin/users/${username}?admin_user_id=${adminUserId}`, {
                    method: 'DELETE'
                });

                const data = await res.json();
                if (res.ok) {
                    alert(`${username} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                    loadUserList();
                } else {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${data.detail}`);
                }
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        async function editUserStaffName(button) {
            const username = button.getAttribute('data-username');
            let currentName = button.getAttribute('data-staff-name');
            
            // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
            const textarea = document.createElement('textarea');
            textarea.innerHTML = currentName;
            currentName = textarea.value;
            
            const newName = prompt(`ã‚¹ã‚¿ãƒƒãƒ•åã‚’ç·¨é›†ã—ã¦ãã ã•ã„\nç¾åœ¨: ${currentName}`, currentName);
            if (newName === null || newName.trim() === '') return;

            try {
                const adminUserId = localStorage.getItem('userId');
                const res = await fetch(`${API_BASE}/auth/admin/users/${username}?admin_user_id=${adminUserId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ staff_name: newName })
                });

                const data = await res.json();
                if (res.ok) {
                    alert(`ã‚¹ã‚¿ãƒƒãƒ•åã‚’æ›´æ–°ã—ã¾ã—ãŸ: ${data.staff_name}`);
                    loadUserList();
                } else {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${data.detail}`);
                }
            } catch (error) {
                console.error('ã‚¹ã‚¿ãƒƒãƒ•åæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        async function loadSecurityLogs() {
            try {
                const adminUserId = localStorage.getItem('userId');
                const messageDiv = document.getElementById('securityStatsMessage');
                
                if (!adminUserId) {
                    throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                }
                
                messageDiv.innerHTML = '<p style="color: #3498db;">ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
                
                const url = `${API_BASE}/admin/security-logs?admin_user_id=${adminUserId}&days=7&limit=500`;
                console.log('Fetching from:', url);
                
                const res = await fetch(url);
                console.log('Response status:', res.status);
                
                const data = await res.json();
                console.log('Response data:', data);
                
                if (!res.ok) throw new Error(data.detail || 'ãƒ­ã‚°å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                
                const tableBody = document.getElementById('securityLogsTableBody');
                
                if (!data.logs || data.logs.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" style="padding: 10px; text-align: center; color: #999;">ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                    messageDiv.innerHTML = '<p style="color: #2ecc71;">âœ“ ãƒ­ã‚°ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼ˆ0ä»¶ï¼‰</p>';
                    return;
                }
                
                let html = '';
                data.logs.forEach(log => {
                    const timestamp = new Date(log.timestamp).toLocaleString('ja-JP');
                    const statusColor = log.success ? '#27ae60' : '#e74c3c';
                    const statusText = log.success ? 'æˆåŠŸ' : 'å¤±æ•—';
                    
                    html += `<tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 8px; font-size: 11px;">${timestamp}</td>
                        <td style="padding: 8px; font-size: 11px;">${log.event_type}</td>
                        <td style="padding: 8px; font-size: 11px;">${log.username || '(ä¸æ˜)'}</td>
                        <td style="padding: 8px; font-size: 11px;">${log.ip_address}</td>
                        <td style="padding: 8px; text-align: center; color: ${statusColor}; font-weight: bold;">${statusText}</td>
                        <td style="padding: 8px; text-align: center;">
                            <button onclick="deleteSecurityLog(${log.id})" style="padding: 3px 8px; background-color: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">å‰Šé™¤</button>
                        </td>
                    </tr>`;
                });
                
                tableBody.innerHTML = html;
                messageDiv.innerHTML = `<p style="color: #2ecc71;">âœ“ ${data.logs.length}ä»¶ã®ãƒ­ã‚°ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ</p>`;
            } catch (error) {
                console.error('ãƒ­ã‚°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('securityStatsMessage').innerHTML = `<p style="color: #e74c3c;">âœ— ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }
        
        async function deleteSecurityLog(logId) {
            if (!confirm('ã“ã®ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                const adminUserId = localStorage.getItem('userId');
                if (!adminUserId) {
                    throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                const res = await fetch(`${API_BASE}/admin/security-logs/${logId}?admin_user_id=${adminUserId}`, {
                    method: 'DELETE'
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.detail || 'ãƒ­ã‚°å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                
                alert('ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                loadSecurityLogs(); // ãƒ­ã‚°ãƒªã‚¹ãƒˆã‚’å†åº¦èª­ã¿è¾¼ã‚€
            } catch (error) {
                console.error('ãƒ­ã‚°å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        async function clearAllSecurityLogs() {
            if (!confirm('ã™ã¹ã¦ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            
            try {
                const adminUserId = localStorage.getItem('userId');
                if (!adminUserId) {
                    throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                const res = await fetch(`${API_BASE}/admin/security-logs-all?admin_user_id=${adminUserId}`, {
                    method: 'DELETE'
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.detail || 'ãƒ­ã‚°ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
                
                alert(data.message);
                loadSecurityLogs(); // ãƒ­ã‚°ãƒªã‚¹ãƒˆã‚’å†åº¦èª­ã¿è¾¼ã‚€
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
                alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        async function loadSecurityStats() {
            try {
                const adminUserId = localStorage.getItem('userId');
                const res = await fetch(`${API_BASE}/admin/security-stats?admin_user_id=${adminUserId}&days=7`);
                if (!res.ok) throw new Error('çµ±è¨ˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                
                const data = await res.json();
                const stats = data.stats;
                
                let html = `<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div style="padding: 10px; background-color: #27ae60; color: white; border-radius: 4px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;">${stats.login_success}</div>
                        <div style="font-size: 12px;">ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ</div>
                    </div>
                    <div style="padding: 10px; background-color: #e74c3c; color: white; border-radius: 4px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;">${stats.login_failure}</div>
                        <div style="font-size: 12px;">ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—</div>
                    </div>
                    <div style="padding: 10px; background-color: #e67e22; color: white; border-radius: 4px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;">${stats.rate_limit_exceeded}</div>
                        <div style="font-size: 12px;">ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é</div>
                    </div>
                    <div style="padding: 10px; background-color: #c0392b; color: white; border-radius: 4px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;">${stats.unauthorized_access}</div>
                        <div style="font-size: 12px;">ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ</div>
                    </div>
                    <div style="padding: 10px; background-color: #8e44ad; color: white; border-radius: 4px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;">${stats.user_deleted}</div>
                        <div style="font-size: 12px;">å‰Šé™¤ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
                    </div>
                    <div style="padding: 10px; background-color: #16a085; color: white; border-radius: 4px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;">${stats.csv_uploads}</div>
                        <div style="font-size: 12px;">CSV ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
                    </div>
                </div>`;
                
                document.getElementById('securityStatsMessage').innerHTML = html;
            } catch (error) {
                console.error('çµ±è¨ˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('securityStatsMessage').innerHTML = `<p style="color: #e74c3c;">âœ— ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        function applyAuthUI() {
            const userId = localStorage.getItem('userId');
            const role = localStorage.getItem('userRole');
            const username = localStorage.getItem('username');
            const mainElement = document.querySelector('main');
            const navElement = document.querySelector('nav');
            const headerAuthControls = document.getElementById('authControls');
            const storeSelectSection = document.getElementById('storeSelectSection');

            // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹è¡¨ç¤º
            if (userId) {
                // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ï¼šmain, navã‚’è¡¨ç¤ºã€ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’éš ã™ã€åº—èˆ—é¸æŠã‚’è¡¨ç¤º
                if (mainElement) mainElement.style.display = 'block';
                if (navElement) navElement.style.display = 'flex';
                if (storeSelectSection) storeSelectSection.style.display = 'flex';
                if (headerAuthControls) {
                    document.getElementById('loginUsername').style.display = 'none';
                    document.getElementById('loginPassword').style.display = 'none';
                    document.getElementById('loginBtn').style.display = 'none';
                    document.getElementById('logoutBtn').style.display = 'inline-block';
                    document.getElementById('loggedInUser').textContent = username ? `${username}` : '';
                }
                
                // æ¨©é™ãŒå¤‰ã‚ã£ãŸã¨ãã«åº—èˆ—ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                setTimeout(async () => {
                    console.log('ğŸ”‘ Logged in user detected - loading store list and data...');
                    setCurrentMonth();
                    await loadStoreList();
                    setupStoreSelectListener();
                    await loadAu1CollectionData();
                    
                    // ç®¡ç†è€…ã®å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
                    if (role === 'admin') {
                        await loadUserList();
                    }
                    console.log('âœ… All post-login initialization complete');
                }, 100);
            } else {
                // æœªãƒ­ã‚°ã‚¤ãƒ³ï¼šmain, navã‚’éš ã™ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºã€åº—èˆ—é¸æŠã‚’éš ã™
                if (mainElement) mainElement.style.display = 'none';
                if (navElement) navElement.style.display = 'none';
                if (storeSelectSection) storeSelectSection.style.display = 'none';
                if (headerAuthControls) {
                    document.getElementById('loginUsername').style.display = 'inline-block';
                    document.getElementById('loginPassword').style.display = 'inline-block';
                    document.getElementById('loginBtn').style.display = 'inline-block';
                    document.getElementById('logoutBtn').style.display = 'none';
                    document.getElementById('loggedInUser').textContent = '';
                }
                
                // åº—èˆ—é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                const select = document.getElementById('storeSelect');
                if (select) {
                    select.innerHTML = '';
                    select.disabled = true;
                    select.onchange = null;
                }
            }

            // æ¨©é™ã«å¿œã˜ãŸã‚¿ãƒ–è¡¨ç¤ºåˆ¶å¾¡
            // æ¨©é™ã«å¿œã˜ãŸã‚¿ãƒ–è¡¨ç¤ºåˆ¶å¾¡
            const adminNav = document.getElementById('adminNavBtn');
            const userSettingsNav = document.getElementById('userSettingsNavBtn');
            const securityNav = document.getElementById('securityNavBtn');

            if (role === 'admin') {
                // ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šç®¡ç†è€…ã‚¿ãƒ–ã¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¿ãƒ–ã‚’è¡¨ç¤ºã€è¨­å®šã‚¿ãƒ–ã‚’éè¡¨ç¤º
                if (adminNav) adminNav.style.display = 'inline-block';
                if (securityNav) securityNav.style.display = 'inline-block';
                if (userSettingsNav) userSettingsNav.style.display = 'none';
                const adminLoginForm = document.getElementById('adminLoginForm');
                const adminContent = document.getElementById('adminContent');
                if (adminLoginForm) adminLoginForm.style.display = 'none';
                if (adminContent) adminContent.style.display = 'block';
            } else if (role === 'manager' && userId) {
                // ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šç®¡ç†è€…ã‚¿ãƒ–ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¿ãƒ–ã‚’éè¡¨ç¤ºã€è¨­å®šã‚¿ãƒ–ã‚‚éè¡¨ç¤º
                if (adminNav) adminNav.style.display = 'none';
                if (securityNav) securityNav.style.display = 'none';
                if (userSettingsNav) userSettingsNav.style.display = 'none';
                const adminLoginForm = document.getElementById('adminLoginForm');
                const adminContent = document.getElementById('adminContent');
                if (adminLoginForm) adminLoginForm.style.display = 'none';
                if (adminContent) adminContent.style.display = 'none';
            } else if (userId) {
                // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šç®¡ç†è€…ã‚¿ãƒ–ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¿ãƒ–ã‚’éè¡¨ç¤ºã€è¨­å®šã‚¿ãƒ–ã‚’è¡¨ç¤º
                if (adminNav) adminNav.style.display = 'none';
                if (securityNav) securityNav.style.display = 'none';
                if (userSettingsNav) userSettingsNav.style.display = 'inline-block';
                const adminLoginForm = document.getElementById('adminLoginForm');
                const adminContent = document.getElementById('adminContent');
                if (adminLoginForm) adminLoginForm.style.display = 'block';
                if (adminContent) adminContent.style.display = 'none';
            } else {
                // æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ï¼šã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚‚ã‚¯ãƒªã‚¢
                if (adminNav) adminNav.style.display = 'inline-block';
                if (securityNav) securityNav.style.display = 'none';
                if (userSettingsNav) userSettingsNav.style.display = 'none';
                const adminContent = document.getElementById('adminContent');
                if (adminLoginForm) adminLoginForm.style.display = 'none';
                if (adminContent) adminContent.style.display = 'none';
            }
        }

        async function loginUser() {
            try {
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                if (!username || !password) {
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (!res.ok) {
                    const err = await res.json();
                    alert(err.detail || 'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—');
                    return;
                }

                const data = await res.json();
                localStorage.setItem('userId', data.user_id);
                localStorage.setItem('username', data.username);
                localStorage.setItem('userRole', data.role);
                localStorage.setItem('userStoreCode', data.store_code || '');

                // UIã‚’æ›´æ–°
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                applyAuthUI();
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        function logoutUser() {
            localStorage.removeItem('userId');
            localStorage.removeItem('username');
            localStorage.removeItem('userRole');
            localStorage.removeItem('userStoreCode');
            
            // UIçŠ¶æ…‹ã‚’å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆ
            const select = document.getElementById('storeSelect');
            if (select) {
                select.innerHTML = '';
                select.disabled = true;
                select.onchange = null;
            }
            
            applyAuthUI();
        }

        // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨: CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ã‚¯ã‚¨ãƒªã«ä»˜ä¸ï¼‰
        const userCsvFile = document.getElementById('userCsvFile');
        const userUploadBtn = document.getElementById('userUploadBtn');
        const userUploadSection = document.getElementById('userUploadSection');

        if (userCsvFile) userCsvFile.addEventListener('change', () => { userUploadBtn.disabled = !userCsvFile.files.length; });

        if (userUploadBtn) userUploadBtn.addEventListener('click', async () => {
            const messageDiv = document.getElementById('userUploadMessage');
            messageDiv.innerHTML = '';
            const userId = localStorage.getItem('userId');
            if (!userId) { messageDiv.innerHTML = '<div class="message error">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</div>'; return; }

            if (!userCsvFile.files.length) return;
            userUploadBtn.disabled = true; userUploadBtn.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';

            try {
                const formData = new FormData();
                formData.append('file', userCsvFile.files[0]);
                console.log('ğŸ“¤ CSV Upload - user_id:', userId, 'file:', userCsvFile.files[0].name);
                const resp = await fetch(`${API_BASE}/upload?user_id=${userId}`, { method: 'POST', body: formData });
                const data = await resp.json();
                console.log('ğŸ“¥ CSV Upload response:', resp.status, data);
                if (resp.ok) {
                    messageDiv.innerHTML = `<div class="message success">âœ“ ${data.count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ</div>`;
                    userCsvFile.value = '';
                    setTimeout(() => { loadStoreList(); switchTab('dashboard'); }, 1200);
                } else {
                    const errorMsg = data.detail || JSON.stringify(data);
                    console.error('âŒ CSV Upload Error:', errorMsg);
                    messageDiv.innerHTML = `<div class="message error">âœ— ã‚¨ãƒ©ãƒ¼: ${errorMsg}</div>`;
                }
            } catch (err) {
                console.error('âŒ CSV Upload Exception:', err);
                messageDiv.innerHTML = `<div class="message error">âœ— ${err.message}</div>`;
            } finally {
                userUploadBtn.disabled = false; userUploadBtn.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰';
            }
        });

        // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
        document.getElementById('userChangePasswordBtn').addEventListener('click', async () => {
            const oldPw = document.getElementById('userOldPassword').value;
            const newPw = document.getElementById('userNewPassword').value;
            const confirmPw = document.getElementById('userConfirmPassword').value;
            const msgDiv = document.getElementById('userChangePasswordMessage');
            msgDiv.innerHTML = '';

            if (!oldPw || !newPw || !confirmPw) { msgDiv.innerHTML = '<p style="color: #e74c3c;">ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>'; return; }
            if (newPw !== confirmPw) { msgDiv.innerHTML = '<p style="color: #e74c3c;">ç¢ºèªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“</p>'; return; }

            const userId = localStorage.getItem('userId');
            if (!userId) { msgDiv.innerHTML = '<p style="color: #e74c3c;">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</p>'; return; }

            try {
                const res = await fetch(`${API_BASE}/auth/change-password?user_id=${encodeURIComponent(userId)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ old_password: oldPw, new_password: newPw })
                });
                if (res.ok) {
                    document.getElementById('userOldPassword').value = '';
                    document.getElementById('userNewPassword').value = '';
                    document.getElementById('userConfirmPassword').value = '';
                    msgDiv.innerHTML = '<p style="color: #2ecc71;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ</p>';
                } else {
                    const err = await res.json();
                    msgDiv.innerHTML = `<p style="color: #e74c3c;">${err.detail}</p>`;
                }
            } catch (err) {
                msgDiv.innerHTML = `<p style="color: #e74c3c;">ã‚¨ãƒ©ãƒ¼: ${err.message}</p>`;
            }
        });

        // ç®¡ç†è€…èªè¨¼é–¢æ•°
        async function verifyAdminPassword() {
            try {
                const password = document.getElementById('adminPassword').value;
                
                if (!password) {
                    document.getElementById('adminLoginMessage').innerHTML = '<p style="color: #e74c3c;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>';
                    return;
                }
                
                const response = await fetch(`${API_BASE}/admin/verify-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });
                
                if (response.ok) {
                    sessionStorage.setItem('adminAuthenticated', 'true');
                    document.getElementById('adminLoginForm').style.display = 'none';
                    document.getElementById('adminContent').style.display = 'block';
                    document.getElementById('adminLoginMessage').innerHTML = '<p style="color: #2ecc71;">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ</p>';
                    // åº—èˆ—ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
                    loadAdminStoreList();
                } else {
                    document.getElementById('adminLoginMessage').innerHTML = '<p style="color: #e74c3c;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“</p>';
                }
            } catch (error) {
                console.error('èªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('adminLoginMessage').innerHTML = `<p style="color: #e74c3c;">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        async function changeAdminPassword() {
            try {
                const oldPassword = document.getElementById('oldPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (!oldPassword || !newPassword || !confirmPassword) {
                    document.getElementById('changePasswordMessage').innerHTML = '<p style="color: #e74c3c;">ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>';
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    document.getElementById('changePasswordMessage').innerHTML = '<p style="color: #e74c3c;">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“</p>';
                    return;
                }
                
                const response = await fetch(`${API_BASE}/admin/change-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ old_password: oldPassword, new_password: newPassword })
                });
                
                if (response.ok) {
                    document.getElementById('oldPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    document.getElementById('changePasswordMessage').innerHTML = '<p style="color: #2ecc71;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ</p>';
                } else {
                    const error = await response.json();
                    document.getElementById('changePasswordMessage').innerHTML = `<p style="color: #e74c3c;">${error.detail}</p>`;
                }
            } catch (error) {
                console.error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('changePasswordMessage').innerHTML = `<p style="color: #e74c3c;">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        async function clearAllData() {
            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
            const confirmed = confirm('æœ¬å½“ã«ã™ã¹ã¦ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚');
            if (!confirmed) {
                return;
            }

            // äºŒé‡ç¢ºèª
            const doubleConfirmed = confirm('è­¦å‘Š: æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');
            if (!doubleConfirmed) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/clear-data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('clearDataMessage').innerHTML = `<p style="color: #2ecc71;">${result.message}</p>`;
                    console.log('ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢å®Œäº†:', result);
                } else {
                    const error = await response.json();
                    document.getElementById('clearDataMessage').innerHTML = `<p style="color: #e74c3c;">ã‚¨ãƒ©ãƒ¼: ${error.detail}</p>`;
                }
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('clearDataMessage').innerHTML = `<p style="color: #e74c3c;">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        // ç®¡ç†è€…ãƒšãƒ¼ã‚¸ã‚’é–‹ãæ™‚ã«èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (this.getAttribute('data-tab') === 'admin') {
                    const isAuthenticated = sessionStorage.getItem('adminAuthenticated') === 'true';
                    if (isAuthenticated) {
                        document.getElementById('adminLoginForm').style.display = 'none';
                        document.getElementById('adminContent').style.display = 'block';
                        // åº—èˆ—ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
                        loadAdminStoreList();
                    } else {
                        document.getElementById('adminLoginForm').style.display = 'block';
                        document.getElementById('adminContent').style.display = 'none';
                    }
                }
            });
        });

        // åˆ†æã‚°ãƒ©ãƒ•
        let dailyChartInstance = null;
        let au1DailyChartInstance = null;
        let productChartInstance = null;

        async function loadAnalysis() {
            try {
                const storeCode = document.getElementById('storeSelect').value;
                const queryParam = storeCode ? `?store_code=${storeCode}` : '';
                console.log(`ğŸ“Š Loading analysis data${queryParam ? ` for store: ${storeCode}` : ' (all stores)'}`);
                
                const dailyResponse = await fetch(`${API_BASE}/summary/daily${queryParam}`);
                const dailyData = await dailyResponse.json();
                console.log(`ğŸ“Š Daily data loaded:`, dailyData);

                const au1DailyResponse = await fetch(`${API_BASE}/au1-collection/daily${queryParam}`);
                const au1DailyData = await au1DailyResponse.json();
                console.log(`ğŸ“Š au+1Collection daily data loaded:`, au1DailyData);

                const productResponse = await fetch(`${API_BASE}/summary/product${queryParam}`);
                const productData = await productResponse.json();
                console.log(`ğŸ“Š Product data loaded:`, productData);

                drawDailyChart(dailyData);
                drawAu1DailyChart(au1DailyData);
                drawProductChart(productData);
                console.log('âœ… Analysis charts rendered');
            } catch (error) {
                console.error('âŒ Error loading analysis:', error);
            }
        }

        function drawDailyChart(data) {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            
            if (dailyChartInstance) {
                dailyChartInstance.destroy();
            }

            const labels = data.map(d => d.date);
            const sales = data.map(d => Math.round(d.total_sales));
            const profit = data.map(d => Math.round(d.gross_profit));

            dailyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'å£²ä¸Š',
                            data: sales,
                            borderColor: '#8884d8',
                            backgroundColor: 'rgba(136, 132, 216, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'ç²—åˆ©',
                            data: profit,
                            borderColor: '#82ca9d',
                            backgroundColor: 'rgba(130, 202, 157, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function drawAu1DailyChart(data) {
            const ctx = document.getElementById('au1DailyChart').getContext('2d');
            
            if (au1DailyChartInstance) {
                au1DailyChartInstance.destroy();
            }

            const labels = data.map(d => d.date);
            const sales = data.map(d => Math.round(d.total_sales));
            const profit = data.map(d => Math.round(d.gross_profit));

            au1DailyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'å£²ä¸Š',
                            data: sales,
                            borderColor: '#ff7300',
                            backgroundColor: 'rgba(255, 115, 0, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'ç²—åˆ©',
                            data: profit,
                            borderColor: '#ff0000',
                            backgroundColor: 'rgba(255, 0, 0, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function drawProductChart(data) {
            const ctx = document.getElementById('productChart').getContext('2d');
            
            if (productChartInstance) {
                productChartInstance.destroy();
            }

            const topProducts = data.sort((a, b) => b.total_sales - a.total_sales).slice(0, 25);
            
            const labels = topProducts.map(p => p.product_name);
            const sales = topProducts.map(p => Math.round(p.total_sales));
            const profit = topProducts.map(p => Math.round(p.total_gross_profit));

            productChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'å£²ä¸Š',
                            data: sales,
                            backgroundColor: '#8884d8'
                        },
                        {
                            label: 'ç²—åˆ©',
                            data: profit,
                            backgroundColor: '#82ca9d'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // åˆæœŸãƒ­ãƒ¼ãƒ‰
        loadDashboard();

        // å€‹äººåˆ¥æˆç¸¾é–¢é€£ã®é–¢æ•°
        function setCurrentMonth() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            
            // å½“æœˆã®1æ—¥
            const firstDay = `${year}-${month}-01`;
            
            // å½“æœˆã®æœ€çµ‚æ—¥
            const lastDay = new Date(year, today.getMonth() + 1, 0);
            const lastDayStr = `${year}-${month}-${String(lastDay.getDate()).padStart(2, '0')}`;
            
            document.getElementById('startDateFilter').value = firstDay;
            document.getElementById('endDateFilter').value = lastDayStr;
        }

        async function loadStaffList() {
            try {
                const storeCode = document.getElementById('storeSelect').value;
                const queryParam = storeCode ? `?store_code=${storeCode}` : '';
                
                const response = await fetch(`${API_BASE}/summary/staff-list${queryParam}`);
                const staffList = await response.json();
                
                const select = document.getElementById('staffSelect');
                const currentValue = select.value;
                
                // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆå…¨å“¡ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ä¿æŒï¼‰
                select.innerHTML = '<option value="">-- å…¨å“¡ --</option>';
                
                // ã‚¹ã‚¿ãƒƒãƒ•ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                staffList.forEach(staff => {
                    const option = document.createElement('option');
                    option.value = staff.staff_id;
                    option.textContent = `${staff.staff_name} (${staff.staff_id})`;
                    select.appendChild(option);
                });
                
                select.value = currentValue;
            } catch (error) {
                console.error('ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        async function loadStoreList() {
            try {
                console.log('ğŸ”„ loadStoreList() called');
                const response = await fetch(`${API_BASE}/admin/stores`);
                const result = await response.json();
                const stores = result.data || [];
                console.log('ğŸ“ Stores loaded:', stores);
                
                const select = document.getElementById('storeSelect');
                if (!select) {
                    console.error('âŒ storeSelect element not found');
                    return;
                }
                
                const userRole = localStorage.getItem('userRole');
                const userStoreCode = localStorage.getItem('userStoreCode');
                console.log(`ğŸ‘¤ User role: ${userRole}, Store: ${userStoreCode}`);
                
                // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                select.innerHTML = '';
                select.onchange = null;
                
                // ç®¡ç†è€…ã¾ãŸã¯ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®å ´åˆï¼šå…¨åº—èˆ—è¡¨ç¤º
                if (userRole === 'admin' || userRole === 'manager') {
                    select.innerHTML = '<option value="">-- å…¨åº—èˆ— --</option>';
                    select.disabled = false;  // åº—èˆ—é¸æŠã‚’æœ‰åŠ¹
                    console.log(`âœ… ${userRole === 'admin' ? 'Admin' : 'Manager'} mode: showing all stores, select.disabled =`, select.disabled);
                    
                    // åº—èˆ—ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                    stores.forEach(store => {
                        const option = document.createElement('option');
                        option.value = store.store_code;
                        option.textContent = `${store.store_name} (${store.store_code})`;
                        select.appendChild(option);
                    });
                    console.log(`âœ… Added ${stores.length} options to select`);
                    
                    // å‰å›ã®å€¤ã‚’å¾©å…ƒï¼ˆã‚ã‚Œã°ï¼‰
                    if (sessionStorage.getItem('selectedStoreCode')) {
                        select.value = sessionStorage.getItem('selectedStoreCode');
                        console.log('âœ… Restored previous store selection');
                    }
                } else if (userRole === 'user' && userStoreCode) {
                    // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆï¼šè‡ªåˆ†ã®åº—èˆ—ã®ã¿è¡¨ç¤º
                    const userStore = stores.find(s => s.store_code === userStoreCode);
                    if (userStore) {
                        const option = document.createElement('option');
                        option.value = userStore.store_code;
                        option.textContent = `${userStore.store_name} (${userStore.store_code})`;
                        select.appendChild(option);
                    } else {
                        const option = document.createElement('option');
                        option.value = userStoreCode;
                        option.textContent = userStoreCode;
                        select.appendChild(option);
                    }
                    select.value = userStoreCode;
                    select.disabled = true;  // åº—èˆ—é¸æŠã‚’ç¦æ­¢
                    console.log('âœ… User mode: showing only user store, select.disabled =', select.disabled);
                } else {
                    // ãƒ­ã‚°ã‚¤ãƒ³å‰ï¼šä½•ã‚‚è¡¨ç¤ºã—ãªã„
                    select.disabled = true;
                    console.log('âŒ No role or store - select disabled');
                }
                
                console.log('ğŸ”„ Calling data load functions...');
                // æ›´æ–°ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã«å³åº§ã«ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                await loadStaffList();
                await loadDashboardStats();
                await loadSalesData();  // ç®¡ç†è€…ãƒšãƒ¼ã‚¸
                await loadAu1CollectionData();  // å€‹äººåˆ¥æˆç¸¾ãƒ»ã‚°ãƒ©ãƒ•ç”¨ãƒ‡ãƒ¼ã‚¿
                await loadAnalysis();  // åˆ†æãƒ»ã‚°ãƒ©ãƒ•ã‚¿ãƒ–ç”¨ãƒ‡ãƒ¼ã‚¿
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã®åº—èˆ—ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
                updateNewStoreCodeSelect();
                console.log('âœ… loadStoreList() completed successfully');
            } catch (error) {
                console.error('âŒ åº—èˆ—ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        function setupStoreSelectListener() {
            const select = document.getElementById('storeSelect');
            if (!select) return;
            
            // å¤ã„ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ï¼ˆæ–°ã—ã„ãƒãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ç½®ãæ›ãˆï¼‰
            const newSelect = select.cloneNode(true);
            select.parentNode.replaceChild(newSelect, select);
            
            // æ–°ã—ã„ãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²
            newSelect.onchange = () => {
                const selectedStore = newSelect.value;
                console.log(`ğŸª Store selected: ${selectedStore}`);
                // é¸æŠã—ãŸåº—èˆ—ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                if (selectedStore) {
                    sessionStorage.setItem('selectedStoreCode', selectedStore);
                    console.log(`ğŸ’¾ Saved to sessionStorage: ${selectedStore}`);
                } else {
                    sessionStorage.removeItem('selectedStoreCode');
                    console.log('ğŸ’¾ Cleared store selection from sessionStorage');
                }
                // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                loadStaffList();
                loadDashboardStats();
                loadSalesData();
                loadAu1CollectionData();  // å€‹äººåˆ¥æˆç¸¾ãƒ»ã‚°ãƒ©ãƒ•ç”¨ãƒ‡ãƒ¼ã‚¿
                loadAnalysis();  // åˆ†æãƒ»ã‚°ãƒ©ãƒ•ã‚¿ãƒ–ç”¨ãƒ‡ãƒ¼ã‚¿
            };
        }

        async function saveStoreSelectionAndRefresh() {
            const select = document.getElementById('storeSelect');
            if (select) {
                const selectedStore = select.value;
                console.log(`ğŸª Update button: saving store selection: ${selectedStore}`);
                if (selectedStore) {
                    sessionStorage.setItem('selectedStoreCode', selectedStore);
                    console.log(`ğŸ’¾ Saved to sessionStorage: ${selectedStore}`);
                } else {
                    sessionStorage.removeItem('selectedStoreCode');
                    console.log('ğŸ’¾ Cleared store selection from sessionStorage');
                }
            }
            // ã‚¹ãƒˆã‚¢ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿ï¼ˆé¸æŠå€¤ã¯ä¿æŒã•ã‚Œã‚‹ï¼‰
            await loadStoreList();
        }

        async function loadAu1CollectionData() {
            try {
                const staffId = document.getElementById('staffSelect').value;
                const storeCode = document.getElementById('storeSelect').value;
                const startDate = document.getElementById('startDateFilter').value;
                const endDate = document.getElementById('endDateFilter').value;
                
                // APIãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
                const params = new URLSearchParams();
                if (staffId) params.append('staff_id', staffId);
                if (storeCode) params.append('store_code', storeCode);
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);
                
                const queryString = params.toString() ? '?' + params.toString() : '';
                const summaryUrl = `${API_BASE}/au1-collection/summary${queryString}`;
                const categoryUrl = `${API_BASE}/au1-collection/category${queryString}`;
                const detailUrl = `${API_BASE}/au1-collection/detail${queryString}`;
                const unitPriceUrl = `${API_BASE}/smartphone/unit-price${queryString}`;
                
                console.log('Loading au+1Collection data...');
                console.log('Summary URL:', summaryUrl);
                
                // ä¸¦è¡Œã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                const [summaryResponse, categoryResponse, detailResponse, unitPriceResponse] = await Promise.all([
                    fetch(summaryUrl),
                    fetch(categoryUrl),
                    fetch(detailUrl),
                    fetch(unitPriceUrl)
                ]);
                
                if (!summaryResponse.ok) {
                    console.warn(`Summary API returned ${summaryResponse.status}`);
                }
                if (!categoryResponse.ok) {
                    console.warn(`Category API returned ${categoryResponse.status}`);
                }
                if (!detailResponse.ok) {
                    console.warn(`Detail API returned ${detailResponse.status}`);
                }
                if (!unitPriceResponse.ok) {
                    console.warn(`Unit Price API returned ${unitPriceResponse.status}`);
                }
                
                const summaryData = (await summaryResponse.json()) || [];
                const categoryData = (await categoryResponse.json()) || [];
                const detailData = (await detailResponse.json()) || [];
                const unitPriceData = (await unitPriceResponse.json()) || [];
                
                console.log('Summary data length:', summaryData.length, 'Sample:', summaryData[0]);
                console.log('Category data length:', categoryData.length);
                console.log('Detail data length:', detailData.length);
                console.log('Unit Price data length:', unitPriceData.length);
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆï¼ˆãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç©ºãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤ºï¼‰
                renderAu1StaffTable(summaryData);
                renderAu1CategoryTable(categoryData);
                renderAu1ProductTable(detailData);
                renderUnitPriceTable(unitPriceData);
                
                // ä¸­åˆ†é¡åˆ¥å††ã‚°ãƒ©ãƒ•ã‚’æç”»
                renderAu1CategoryPieCharts(categoryData);
                
                // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°ï¼ˆå¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹ï¼‰
                updateAu1Statistics(summaryData);
            } catch (error) {
                console.error('au+1Collectionå®Ÿç¸¾ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                console.error('ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯:', error.stack);
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¡¨ç¤º
                updateAu1Statistics([]);
                renderUnitPriceTable([]);
                
                const au1StaffTable = document.getElementById('au1StaffTable');
                if (au1StaffTable) {
                    au1StaffTable.innerHTML = '<p style="color: #d9534f;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ<br/>' + error.message + '</p>';
                }
            }
        }

        function renderUnitPriceTable(data) {
            const tableBody = document.getElementById('unitPriceTableBody');
            
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }
            
            let html = '';
            data.forEach((item, idx) => {
                const bgColor = idx % 2 === 0 ? '#ffffff' : '#f9f9f9';
                html += `<tr style="background-color: ${bgColor}; border-bottom: 1px solid #ddd;">
                    <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold;">${item.staff_name}</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">Â¥${Math.round(item.au1_gross_profit).toLocaleString('ja-JP')}</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${item.smartphone_count}å°</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${item.iphone_count}å°</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold; color: #3498db;">Â¥${Math.round(item.unit_price).toLocaleString('ja-JP')}</td>
                </tr>`;
            });
            
            tableBody.innerHTML = html;
        }

        function updateAu1Statistics(data) {
            let totalSales = 0;
            let totalProfit = 0;
            let totalCount = 0;
            
            if (data && Array.isArray(data)) {
                data.forEach(item => {
                    totalSales += item.total_sales || 0;
                    totalProfit += item.gross_profit || 0;
                    totalCount += item.transaction_count || 0;
                });
            }
            
            console.log('updateAu1Statistics called - Sales:', totalSales, 'Profit:', totalProfit, 'Count:', totalCount);
            
            // å€‹äººåˆ¥ãƒšãƒ¼ã‚¸ã®å£²ä¸Šåˆè¨ˆã‚’è¡¨ç¤º
            const totalSalesElement = document.getElementById('au1StaffTotalSales');
            if (totalSalesElement) {
                totalSalesElement.textContent = Math.round(totalSales).toLocaleString('ja-JP');
                console.log('Updated au1StaffTotalSales to', Math.round(totalSales).toLocaleString('ja-JP'));
            } else {
                console.warn('au1StaffTotalSales element not found');
            }
            
            // å€‹äººåˆ¥ãƒšãƒ¼ã‚¸ã®ç²—åˆ©åˆè¨ˆã‚’è¡¨ç¤º
            const totalProfitElement = document.getElementById('au1StaffTotalProfit');
            if (totalProfitElement) {
                totalProfitElement.textContent = Math.round(totalProfit).toLocaleString('ja-JP');
                console.log('Updated au1StaffTotalProfit to', Math.round(totalProfit).toLocaleString('ja-JP'));
            } else {
                console.warn('au1StaffTotalProfit element not found');
            }
            
            // å€‹äººåˆ¥ãƒšãƒ¼ã‚¸ã®ä»¶æ•°åˆè¨ˆã‚’è¡¨ç¤º
            const totalCountElement = document.getElementById('au1StaffTotalCount');
            if (totalCountElement) {
                totalCountElement.textContent = totalCount.toLocaleString('ja-JP');
                console.log('Updated au1StaffTotalCount to', totalCount.toLocaleString('ja-JP'));
            } else {
                console.warn('au1StaffTotalCount element not found');
            }
        }

        function renderAu1StaffTable(data) {
            const tableDiv = document.getElementById('au1StaffTable');
            
            if (!data || data.length === 0) {
                tableDiv.innerHTML = '<p style="color: #666;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            let html = '<table class="summary-table"><thead><tr>';
            html += '<th>ã‚¹ã‚¿ãƒƒãƒ•</th>';
            html += '<th style="text-align: center;">å–ä»¶æ•°</th>';
            html += '<th style="text-align: right;">å£²ä¸Š</th>';
            html += '<th style="text-align: right;">ç²—åˆ©</th>';
            html += '<th style="text-align: right;">ç²—åˆ©ç‡</th>';
            html += '</tr></thead><tbody>';
            
            data.forEach(staff => {
                const profitRate = staff.total_sales > 0 ? ((staff.gross_profit / staff.total_sales) * 100).toFixed(2) : 0;
                
                html += '<tr>';
                html += `<td><strong>${staff.staff_name}</strong><br/><small>${staff.staff_id}</small></td>`;
                html += `<td style="text-align: center;">${staff.transaction_count}</td>`;
                html += `<td style="text-align: right;">Â¥${Math.round(staff.total_sales).toLocaleString('ja-JP')}</td>`;
                html += `<td style="text-align: right;">Â¥${Math.round(staff.gross_profit).toLocaleString('ja-JP')}</td>`;
                html += `<td style="text-align: right;">${profitRate}%</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            tableDiv.innerHTML = html;
        }

        function renderAu1CategoryTable(data) {
            const tableDiv = document.getElementById('au1CategoryTable');
            
            if (!data || data.length === 0) {
                tableDiv.innerHTML = '<p style="color: #666;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            let html = '<table class="summary-table"><thead><tr>';
            html += '<th>ã‚¹ã‚¿ãƒƒãƒ•</th>';
            html += '<th>ä¸­åˆ†é¡</th>';
            html += '<th style="text-align: center;">ä»¶æ•°</th>';
            html += '<th style="text-align: right;">å£²ä¸Š</th>';
            html += '<th style="text-align: right;">ç²—åˆ©</th>';
            html += '</tr></thead><tbody>';
            
            data.forEach(item => {
                html += '<tr>';
                html += `<td>${item.staff_name}</td>`;
                html += `<td>${item.category || 'æœªåˆ†é¡'}</td>`;
                html += `<td style="text-align: center;">${item.transaction_count}</td>`;
                html += `<td style="text-align: right;">Â¥${Math.round(item.total_sales).toLocaleString('ja-JP')}</td>`;
                html += `<td style="text-align: right;">Â¥${Math.round(item.gross_profit).toLocaleString('ja-JP')}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            tableDiv.innerHTML = html;
        }

        function renderAu1ProductTable(data) {
            const tableDiv = document.getElementById('au1ProductTable');
            
            if (!data || data.length === 0) {
                tableDiv.innerHTML = '<p style="color: #666;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            let html = '<table class="summary-table"><thead><tr>';
            html += '<th>ã‚¹ã‚¿ãƒƒãƒ•</th>';
            html += '<th>å•†å“/ã‚«ãƒ†ã‚´ãƒª</th>';
            html += '<th style="text-align: center;">ä»¶æ•°</th>';
            html += '<th style="text-align: right;">å£²ä¸Š</th>';
            html += '<th style="text-align: right;">ç²—åˆ©</th>';
            html += '</tr></thead><tbody>';
            
            data.forEach(item => {
                html += '<tr>';
                html += `<td>${item.staff_name}</td>`;
                html += `<td>${item.product_name}<br/><small style="color: #999;">${item.category}</small></td>`;
                html += `<td style="text-align: center;">${item.transaction_count}</td>`;
                html += `<td style="text-align: right;">Â¥${Math.round(item.total_sales).toLocaleString('ja-JP')}</td>`;
                html += `<td style="text-align: right;">Â¥${Math.round(item.gross_profit).toLocaleString('ja-JP')}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            tableDiv.innerHTML = html;
        }

        function renderAu1CategoryPieCharts(data) {
            if (!data || data.length === 0) {
                document.getElementById('categoryProfitChart').parentElement.innerHTML = '<p style="color: #666;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // ä¸­åˆ†é¡åˆ¥ã«ç²—åˆ©ã¨å£²ä¸Šã‚’é›†è¨ˆ
            const categoryData = {};
            data.forEach(item => {
                const category = item.category || 'æœªåˆ†é¡';
                if (!categoryData[category]) {
                    categoryData[category] = { profit: 0, sales: 0 };
                }
                categoryData[category].profit += item.gross_profit || 0;
                categoryData[category].sales += item.total_sales || 0;
            });
            
            const categories = Object.keys(categoryData);
            const profits = categories.map(cat => categoryData[cat].profit);
            const sales = categories.map(cat => categoryData[cat].sales);
            
            // é…è‰²ãƒ‘ãƒ¬ãƒƒãƒˆ
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
            ];
            
            try {
                // ç²—åˆ©å††ã‚°ãƒ©ãƒ•
                const profitCtx = document.getElementById('categoryProfitChart').getContext('2d');
                if (window.categoryProfitChartInstance && typeof window.categoryProfitChartInstance.destroy === 'function') {
                    window.categoryProfitChartInstance.destroy();
                }
                window.categoryProfitChartInstance = new Chart(profitCtx, {
                    type: 'doughnut',
                    data: {
                        labels: categories,
                        datasets: [{
                            data: profits,
                            backgroundColor: colors.slice(0, categories.length),
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: { size: 12 },
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = Math.round(context.parsed);
                                        return 'Â¥' + value.toLocaleString('ja-JP');
                                    }
                                }
                            }
                        }
                    }
                });
                
                // å£²ä¸Šå††ã‚°ãƒ©ãƒ•
                const salesCtx = document.getElementById('categorySalesChart').getContext('2d');
                if (window.categorySalesChartInstance && typeof window.categorySalesChartInstance.destroy === 'function') {
                    window.categorySalesChartInstance.destroy();
                }
                window.categorySalesChartInstance = new Chart(salesCtx, {
                    type: 'doughnut',
                    data: {
                        labels: categories,
                        datasets: [{
                            data: sales,
                            backgroundColor: colors.slice(0, categories.length),
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: { size: 12 },
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = Math.round(context.parsed);
                                        return 'Â¥' + value.toLocaleString('ja-JP');
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('å††ã‚°ãƒ©ãƒ•ã®æç”»ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function renderStaffPerformanceTable(data) {
            const staffTableDiv = document.getElementById('staffTable');
            
            if (!data || data.length === 0) {
                staffTableDiv.innerHTML = '<p style="color: #666;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // å…¨ã‚¹ã‚¿ãƒƒãƒ•ã‹ã‚‰å…¨ã‚µãƒ¼ãƒ“ã‚¹ã‚«ãƒ†ã‚´ãƒªã‚’é›†è¨ˆ
            const allServices = new Set();
            data.forEach(staff => {
                Object.keys(staff.services).forEach(service => {
                    allServices.add(service);
                });
            });
            const serviceList = Array.from(allServices).sort();
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ã‚’ç”Ÿæˆ
            let html = '<table class="summary-table"><thead><tr>';
            html += '<th>ã‚¹ã‚¿ãƒƒãƒ•</th>';
            
            serviceList.forEach(service => {
                if (service === 'au+1Collection') {
                    html += `<th>${service}<br/>(ç²—åˆ©)</th>`;
                } else {
                    html += `<th>${service}</th>`;
                }
            });
            
            html += '<th>åˆè¨ˆå£²ä¸Š</th>';
            html += '<th>åˆè¨ˆç²—åˆ©</th>';
            html += '</tr></thead><tbody>';
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœãƒ‡ã‚£ã‚’ç”Ÿæˆ
            data.forEach(staff => {
                html += '<tr>';
                html += `<td><strong>${staff.staff_name}</strong><br/><small>${staff.staff_id}</small></td>`;
                
                // å„ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¡¨ç¤º
                serviceList.forEach(service => {
                    const serviceData = staff.services[service] || { count: 0, gross_profit: 0 };
                    
                    // au+1Collection ã¯ç²—åˆ©ã‚’è¡¨ç¤ºã€ãã®ä»–ã¯ã‚«ã‚¦ãƒ³ãƒˆæ•°ã‚’è¡¨ç¤º
                    if (service === 'au+1Collection') {
                        html += `<td style="text-align: right;">Â¥${(serviceData.gross_profit || 0).toLocaleString('ja-JP')}</td>`;
                    } else {
                        html += `<td style="text-align: center;">${serviceData.count || 0}</td>`;
                    }
                });
                
                // åˆè¨ˆå£²ä¸Šã¨åˆè¨ˆç²—åˆ©
                html += `<td style="text-align: right;">Â¥${(staff.total_sales || 0).toLocaleString('ja-JP')}</td>`;
                html += `<td style="text-align: right;">Â¥${(staff.total_gross_profit || 0).toLocaleString('ja-JP')}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            staffTableDiv.innerHTML = html;
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–å‡¦ç†
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded. Initializing...');
            // èªè¨¼UIåˆæœŸåŒ–
            applyAuthUI();
            
            // ãƒ­ã‚°ã‚¤ãƒ³ / ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            if (loginBtn) loginBtn.addEventListener('click', loginUser);
            if (logoutBtn) logoutBtn.addEventListener('click', logoutUser);
        });

        // newStoreCode ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’åº—èˆ—ãƒªã‚¹ãƒˆã¨é€£æº
        function updateNewStoreCodeSelect() {
            const select = document.getElementById('newStoreCode');
            if (!select) return;
            
            fetch(`${API_BASE}/admin/stores`).then(r => r.json()).then(stores => {
                select.innerHTML = '<option value="">-- åº—èˆ—ã‚’é¸æŠ --</option>';
                stores.data.forEach(store => {
                    const opt = document.createElement('option');
                    opt.value = store.store_code;
                    opt.textContent = `${store.store_code} - ${store.store_name}`;
                    select.appendChild(opt);
                });
            }).catch(err => console.error('åº—èˆ—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err));
        }

        // SQLãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºé–¢é€£ã®å¤‰æ•°ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        let allSalesData = [];
        let currentSortField = 'transaction_date';
        let currentSortOrder = 'desc';

        async function loadSalesData() {
            try {
                document.getElementById('salesDataMessage').innerHTML = '<p style="color: #666;">èª­ã¿è¾¼ã¿ä¸­...</p>';
                
                const storeCode = document.getElementById('storeSelect').value;
                const queryParam = storeCode ? `?store_code=${storeCode}` : '';
                
                const response = await fetch(`${API_BASE}/admin/sales-data${queryParam}`);
                if (!response.ok) throw new Error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                
                const result = await response.json();
                allSalesData = result.data;
                
                document.getElementById('totalRecordCount').textContent = allSalesData.length;
                document.getElementById('salesDataMessage').innerHTML = `<p style="color: #2ecc71;">âœ“ ${allSalesData.length} ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ</p>`;
                
                // ãƒ•ã‚£ãƒ«ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('filterValue').value = '';
                document.getElementById('filterField').value = '';
                document.getElementById('filterMatchCount').textContent = '';
                
                renderSalesDataTable();
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('salesDataMessage').innerHTML = `<p style="color: #e74c3c;">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        function renderSalesDataTable() {
            const tableBody = document.getElementById('salesDataTableBody');
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
            let displayData = allSalesData;
            const filterField = document.getElementById('filterField').value;
            const filterValue = document.getElementById('filterValue').value;
            
            if (filterField && filterValue) {
                displayData = allSalesData.filter(row => {
                    const fieldValue = row[filterField];
                    return fieldValue && fieldValue.toString().toLowerCase().includes(filterValue.toLowerCase());
                });
                document.getElementById('filterMatchCount').textContent = `ãƒãƒƒãƒ: ${displayData.length} ä»¶`;
            }
            
            // ã‚½ãƒ¼ãƒˆé©ç”¨
            displayData = displayData.sort((a, b) => {
                let aVal = a[currentSortField];
                let bVal = b[currentSortField];
                
                if (typeof aVal === 'string') {
                    aVal = (aVal || '').toLowerCase();
                    bVal = (bVal || '').toLowerCase();
                    return currentSortOrder === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                
                aVal = aVal || 0;
                bVal = bVal || 0;
                return currentSortOrder === 'asc' ? aVal - bVal : bVal - aVal;
            });
            
            if (displayData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="11" style="padding: 20px; text-align: center; color: #999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }
            
            let html = '';
            displayData.forEach((row, idx) => {
                const bgColor = idx % 2 === 0 ? '#ffffff' : '#f9f9f9';
                const transDate = new Date(row.transaction_date).toLocaleString('ja-JP');
                
                html += `<tr style="background-color: ${bgColor}; border-bottom: 1px solid #ddd;">
                    <td style="padding: 10px;">${row.id}</td>
                    <td style="padding: 10px;">${transDate}</td>
                    <td style="padding: 10px;">${row.store_code || '-'}</td>
                    <td style="padding: 10px; font-weight: bold;">${row.store_name || row.store_code || '-'}</td>
                    <td style="padding: 10px;">${row.product_name || '-'}</td>
                    <td style="padding: 10px; text-align: right;">${row.quantity || 0}</td>
                    <td style="padding: 10px; text-align: right;">Â¥${(row.total_price || 0).toLocaleString('ja-JP')}</td>
                    <td style="padding: 10px; text-align: right; font-weight: bold; color: #27ae60;">Â¥${(row.gross_profit || 0).toLocaleString('ja-JP')}</td>
                    <td style="padding: 10px; font-weight: bold;">${row.staff_name || '-'}</td>
                    <td style="padding: 10px;">${row.large_category || '-'}</td>
                    <td style="padding: 10px;">${row.small_category || '-'}</td>
                </tr>`;
            });
            
            tableBody.innerHTML = html;
        }

        function sortTable(field) {
            if (currentSortField === field) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortOrder = 'asc';
            }
            renderSalesDataTable();
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´æ™‚ã®å‡¦ç†
        document.addEventListener('DOMContentLoaded', function() {
            const filterField = document.getElementById('filterField');
            const filterValue = document.getElementById('filterValue');
            
            if (filterField) {
                filterField.addEventListener('change', () => renderSalesDataTable());
            }
            if (filterValue) {
                filterValue.addEventListener('input', () => renderSalesDataTable());
            }
        });
    </script>
</body>
</html>
